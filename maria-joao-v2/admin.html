<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Painel de Admin — Maria & João</title>
<link rel="icon" type="image/png" href="https://i.postimg.cc/T3tNdXL6/lirandzo.png">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Estilos rápidos para o admin */
    body { background-color: var(--section-bg); opacity: 1; }
    .admin-container {
      width: 100%;
      max-width: 1000px;
      margin: 48px auto;
      padding: 40px;
      background: var(--card);
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.05);
    }
    #adminLogin { text-align: center; max-width: 400px; margin: 0 auto; }
    #dashboard { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 24px; }
    th, td { padding: 12px; border-bottom: 1px solid var(--border-color); text-align: left; font-size: 0.9rem; }
    th { background: var(--section-bg); }
    tr:hover { background-color: #fcfaf8; }
    
    /* Estilo para o link do comprovativo */
    td a {
        font-weight: 500;
        color: var(--accent);
        text-decoration: none;
    }
    td a:hover {
        text-decoration: underline;
    }
  </style>
</head>
<body>

  <div class="admin-container">
    
    <div id="adminLogin">
      <h2 class="section-title" style="font-size: 2.5rem;">Painel de Gestão</h2>
      <form id="adminLoginForm">
        <div style="text-align: left; margin-bottom: 16px;">
          <label for="adminPassword">Senha de Admin</label>
          <input type="password" id="adminPassword" style="width: 100%;">
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Aceder</button>
      </form>
      <p id="adminLoginError" style="color: #D93025; min-height: 1.2em; margin-top: 16px;"></p>
    </div>

    <div id="dashboard">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <h2 class="section-title" style="font-size: 2.5rem; margin-bottom: 0;">Dashboard</h2>
        <button class="btn btn-outline" id="refreshBtn">Atualizar Listas</button>
      </div>

      <h3 style="margin-top: 40px; margin-bottom: 0;">Confirmações de Presença</h3>
      <p style="margin-top: 16px;">Total de confirmações: <strong id="rsvpCount">0</strong> &nbsp;|&nbsp; Total de convidados: <strong id="guestTotalCount">0</strong></p>
      <div style="overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; margin-top: 16px;">
        <table id="rsvpTable">
          <thead>
            <tr>
              <th>Data</th>
              <th>Nome</th>
              <th>Convidados</th>
              <th>Telefone</th>
              <th>Mensagem</th>
            </tr>
          </thead>
          <tbody id="rsvpTableBody">
            </tbody>
        </table>
      </div>
      
      <hr style="margin: 40px 0;">
      
      <h3>Gestão de Presentes (Lista)</h3>
      <p id="giftSectionP">A carregar dados dos presentes...</p>
      <div id="giftTableContainer" style="overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; margin-top: 16px; display: none;">
        <table id="giftTable">
          <thead>
            <tr>
              <th>Data</th>
              <th>Nome do Convidado</th>
              <th>Presentes Registados</th>
            </tr>
          </thead>
          <tbody id="giftTableBody">
            </tbody>
        </table>
      </div>

      <hr style="margin: 40px 0;">

      <h3>Comprovativos Monetários</h3>
      <p id="comprovativoSectionP">A carregar comprovativos...</p>
      <div id="comprovativoTableContainer" style="overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; margin-top: 16px; display: none;">
        <table id="comprovativoTable">
          <thead>
            <tr>
              <th>Data</th>
              <th>Nome</th>
              <th>Canal</th>
              <th>Comprovativo (Ficheiro)</th>
            </tr>
          </thead>
          <tbody id="comprovativoTableBody">
            </tbody>
        </table>
      </div>

    </div>
  </div>

  <script>
    // ================== MUDANÇA FEITA AQUI ==================
    const ADMIN_API_ENDPOINT = "https://api-casamento-mj.onrender.com/admin-api";
    // ========================================================
    let adminPassword = ""; // Guardará a senha após o login

    const adminLoginForm = document.getElementById('adminLoginForm');
    const adminLoginError = document.getElementById('adminLoginError');
    const refreshBtn = document.getElementById('refreshBtn');

    // Função para escapar HTML e evitar XSS
    const escape = (str) => str ? String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;') : '-';

    // Ação de Login (AGORA BUSCA 3 TIPOS DE DADOS)
    adminLoginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      adminLoginError.textContent = "";
      adminPassword = document.getElementById('adminPassword').value;
      const button = e.target.querySelector('button');
      button.disabled = true;
      button.textContent = "A aceder...";
      
      // Busca RSVPs, Presentes e Comprovativos ao mesmo tempo
      Promise.all([
        fetchData("get_rsvps"),
        fetchData("get_gifts"),
        fetchData("get_comprovativos") // <-- NOVO
      ])
      .then(([rsvpData, giftData, comprovativoData]) => {
          // Sucesso! Esconde login, mostra dashboard
          document.getElementById('adminLogin').style.display = 'none';
          document.getElementById('dashboard').style.display = 'block';
          
          populateRsvpTable(rsvpData.data);
          populateGiftTable(giftData.data); 
          populateComprovativoTable(comprovativoData.data); // <-- NOVO
      })
      .catch(err => {
          adminLoginError.textContent = err.message || "Senha incorreta.";
          button.disabled = false;
          button.textContent = "Aceder";
      });
    });
    
    // Ação de Atualizar (AGORA BUSCA 3 TIPOS DE DADOS)
    refreshBtn.addEventListener('click', () => {
        refreshBtn.disabled = true;
        refreshBtn.textContent = "A atualizar...";
        
        Promise.all([
          fetchData("get_rsvps"),
          fetchData("get_gifts"),
          fetchData("get_comprovativos") // <-- NOVO
        ])
        .then(([rsvpData, giftData, comprovativoData]) => {
            populateRsvpTable(rsvpData.data);
            populateGiftTable(giftData.data); 
            populateComprovativoTable(comprovativoData.data); // <-- NOVO
            refreshBtn.disabled = false;
            refreshBtn.textContent = "Atualizar Listas";
        })
        .catch(err => {
            alert("Erro ao atualizar: " + err.message);
            refreshBtn.disabled = false;
            refreshBtn.textContent = "Atualizar Listas";
        });
    });

    // Função para preencher a tabela de RSVPs
    function populateRsvpTable(rsvps) {
      const tableBody = document.getElementById('rsvpTableBody');
      const countEl = document.getElementById('rsvpCount');
      const guestTotalEl = document.getElementById('guestTotalCount'); 
      tableBody.innerHTML = ''; 
      let totalGuests = 0; 

      if (!rsvps || rsvps.length === 0) {
        countEl.textContent = 0;
        guestTotalEl.textContent = 0; 
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 24px;">Nenhuma confirmação recebida ainda.</td></tr>';
        return;
      }
      
      countEl.textContent = rsvps.length;
      rsvps.forEach(rsvp => {
        let guestsCount = 0;
        let guestsValue = String(rsvp.guests || '0');
        if (guestsValue.includes('+')) {
          guestsCount = parseInt(guestsValue.replace('+', ''));
        } else {
          guestsCount = parseInt(guestsValue);
        }
        if (!isNaN(guestsCount)) {
          totalGuests += guestsCount;
        }
        
        const row = `
          <tr>
            <td style="white-space: nowrap;">${new Date(rsvp.timestamp).toLocaleString('pt-PT', {dateStyle: 'short', timeStyle: 'short'})}</td>
            <td style="font-weight: 500;">${escape(rsvp.nome)}</td>
            <td>${escape(rsvp.guests)}</td>
            <td>${escape(rsvp.phone)}</td>
            <td>${escape(rsvp.message)}</td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });
      guestTotalEl.textContent = totalGuests; 
    }

    // Função para preencher a tabela de Presentes (Lista)
    function populateGiftTable(gifts) {
      const tableContainer = document.getElementById('giftTableContainer');
      const tableBody = document.getElementById('giftTableBody');
      const giftSectionP = document.getElementById('giftSectionP');
      tableBody.innerHTML = '';

      if (!gifts || gifts.length === 0) {
        giftSectionP.textContent = "Nenhum presente da lista foi registado ainda.";
        tableContainer.style.display = 'none';
        return;
      }

      giftSectionP.textContent = "Abaixo está a lista de presentes físicos registados pelos convidados.";
      tableContainer.style.display = 'block';

      gifts.forEach(entry => {
        const row = `
          <tr>
            <td style="white-space: nowrap;">${new Date(entry.timestamp).toLocaleString('pt-PT', {dateStyle: 'short', timeStyle: 'short'})}</td>
            <td style="font-weight: 500;">${escape(entry.nome)}</td>
            <td>${escape(entry.gifts.join(', '))}</td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });
    }

    // --- NOVA FUNÇÃO PARA PREENCHER A TABELA DE COMPROVATIVOS ---
    function populateComprovativoTable(comprovativos) {
      const tableContainer = document.getElementById('comprovativoTableContainer');
      const tableBody = document.getElementById('comprovativoTableBody');
      const comprovativoSectionP = document.getElementById('comprovativoSectionP');
      tableBody.innerHTML = '';

      if (!comprovativos || comprovativos.length === 0) {
        comprovativoSectionP.textContent = "Nenhum comprovativo monetário foi enviado ainda.";
        tableContainer.style.display = 'none';
        return;
      }

      comprovativoSectionP.textContent = "Abaixo estão os comprovativos monetários enviados.";
      tableContainer.style.display = 'block';

      comprovativos.forEach(entry => {
        // O link aponta para a pasta /uploads/ que o server.js está a servir
        // ================== MUDANÇA IMPORTANTE AQUI ==================
        // Em vez de 'uploads/', usamos o URL completo do servidor
        const fileLink = `https://api-casamento-mj.onrender.com/uploads/${escape(entry.fileName)}`;
        // ============================================================
        
        const row = `
          <tr>
            <td style="white-space: nowrap;">${new Date(entry.timestamp).toLocaleString('pt-PT', {dateStyle: 'short', timeStyle: 'short'})}</td>
            <td style="font-weight: 500;">${escape(entry.nome)}</td>
            <td>${escape(entry.canal)}</td>
            <td><a href="${fileLink}" target="_blank" rel="noopener noreferrer">${escape(entry.originalName)}</a></td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });
    }

    // Função genérica para chamar a API de Admin
    function fetchData(action, payload = {}) {
      return fetch(ADMIN_API_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          password: adminPassword, // Envia sempre a senha
          action: action,
          ...payload 
        })
      })
      .then(res => {
          if (!res.ok) {
              return res.json().then(err => Promise.reject(new Error(err.message || 'Erro de servidor')));
          }
          return res.json();
      })
      .then(response => {
        if (response.status !== "success") {
          throw new Error(response.message);
        }
        return response;
      });
    }
  </script>

</body>
</html>